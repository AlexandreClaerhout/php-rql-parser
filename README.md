php-rql-parser - A PHP RQL Parsing Library
==============

[![Build Status](https://travis-ci.org/libgraviton/php-rql-parser.svg?branch=develop)](https://travis-ci.org/libgraviton/php-rql-parser) [![Scrutinizer Code Quality](https://scrutinizer-ci.com/g/libgraviton/php-rql-parser/badges/quality-score.png?b=develop)](https://scrutinizer-ci.com/g/libgraviton/php-rql-parser/?branch=develop) [![Code Coverage](https://scrutinizer-ci.com/g/libgraviton/php-rql-parser/badges/coverage.png?b=develop)](https://scrutinizer-ci.com/g/libgraviton/php-rql-parser/?branch=develop) [![Latest Stable Version](https://poser.pugx.org/graviton/php-rql-parser/v/stable.svg)](https://packagist.org/packages/graviton/php-rql-parser) [![Total Downloads](https://poser.pugx.org/graviton/php-rql-parser/downloads.svg)](https://packagist.org/packages/graviton/php-rql-parser) [![Latest Unstable Version](https://poser.pugx.org/graviton/php-rql-parser/v/unstable.svg)](https://packagist.org/packages/graviton/php-rql-parser) [![License](https://poser.pugx.org/graviton/php-rql-parser/license.svg)](https://packagist.org/packages/graviton/php-rql-parser)


This is a small [RQL](https://github.com/persvr/rql/) (Resource Query Language) parsing library written in PHP. It uses [doctrine/lexer](https://github.com/doctrine/lexer) and
a doctrine inspired parser to create and abstract syntax tree of the query. While it ships with a [doctrine/mongo-odm](https://github.com/doctrine/mongodb-odm) querybuilding
visitor writing you own should not be hard.

This package adheres to [SemVer](http://semver.org/spec/v2.0.0.html) versioning. It will be considered stable after reaching 2.x since the initial 1.x release is
considered too buggy at the moment.

It uses a github version of [git-flow](http://nvie.com/posts/a-successful-git-branching-model/) in which new features and bugfixes must be merged to develop
using a github pull request. It uses the standard git-flow naming conventions with the addition of a 'v' prefix to version tags.

This library is under heavy development. If you need an RQL parser for PHP please consider pitching in by contributing to this parser.

## Overview

This library consists of the following parts:

* a lexer and parser for creating an abstract syntax tree from rql code
* a visitor implementation for using a mongo-odm quiery builder with the abstract syntax tree
* unit and acceptance tests for all this

## Installation

Install it using composer.

```bash
composer require graviton/php-rql-parser
```

## Current state

All this can currently do is parse a very limited subset of rql. Please have a look 
at ``test/LexerTest.php`` and ``test/ParserTest.php`` to
see what the parser currently supports.

The mongo-odm visitor only supports a limited subset of rql. Look at ``test/MongoOdmTest.php``
to see how to use it and what is supported.

## Development

We welcome contributions on the develop branch.

To interface this with a backend (like MongoDB or PHP ActiveRecord) you need to
implement a visitor. This visitor is then responsible for walking the abstract
syntax tree generated by the parser.

### Adding a Visitor

Please look at the ``src/Visitor/`` for examples of how to traverse the abstract syntax
tree if you need to implement some thing based off the parser.

You visitor will get passed the AST but will will need to traverse the array on its own.

```php
<?php

use Graviton\Rql\Visitor\VistorInterface;
use Graviton\Rql\AST\OperationInterface;

class DemoVisitor implements VisitorInterface
{
    public function visit(OperationInterface $operation)
    {
        // look at operations class and implemented interfaces and apply things
        // ...
        
        // check to see if we need to iterate
        if ($operation instanceof QueryOperationInterface) {
            foreach ($operation->getQueries() as $query) {
                $this->visit($query);
            }
        }
    }
}

```

### The AST

The AST that your visitor needs to traverse is built from the following class tree.

* ``AbstractOperation``
  * ``AbstractPropertyOperation``
    * ``EqOperation``
    * ``NeOperation``
    * ``LtOperation``
    * ``GtOperation``
    * ``LteOperation``
    * ``GteOperation``
    * ``LikeOperation``
  * ``AbstractQueryOperation``
    * ``AndOperation``
    * ``OrOperation``
  * ``AbstractArrayOperation``
    * ``InOperation``
    * ``OutOperation``
  * ``LimitOperation``
  * ``SortOperation``

The grouping of the operations is mostly based on the similarity of their call
signatures. This is exposed through the following interfaces that you may use
for dispatching in your visitor.

* ``PropertyOperationInterface``
* ``QueryOperationInterface``
* ``ArrayOperationInterface``
* ``LimitOperationInterface``
* ``SortOperationInterface``
